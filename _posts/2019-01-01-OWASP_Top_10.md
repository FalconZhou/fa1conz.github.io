---
layout:     post
title:      "OWASP TOP 10 v2017 官方解释及个人理解"
subtitle:   "OWASP TOP 10"
date:       2019-01-01 12:00:00 +0800
author:     "Fa1ConZ"
header-img: "img/post-bg-2015.jpg"
tags:
    - OWASP
---

https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project

[TOC]

# A1: 注入

> 将不受信任的数据作为命令或查询的一部分发送到解析器时，会产生一些常见的注入，包括：SQL、OS命令、ORM、LDAP和表达式语言（EL）或OGNL注入的注入缺陷。攻击者的恶意数据可以诱使解析器在没有适当授权的情况下执行非预期命令或访问数据。


可能导致漏洞的情况：
- 未对用户提供的数据进行验证、过滤。
- 恶意数据直接被使用或连接，如在动态查询语句、命令或存储过程中包含结构和恶意数据。
- 动态查询语句或非参数化的调用，在没有上下文感知转义的情况下，被用于解释器。
- 在ORM搜索参数中使用了恶意数据。
 
防护办法：
防止注入漏洞需要将数据与命令语句、查询语句分隔开来。
- 最佳选择：**使用安全的API**，完全避免使用解释器，或提供参数化界面的接口，或迁移到ORM或实体框架。
  - 当参数化时，存储过程仍然可以引入SQL注入，如果PL/SQL或T-SQL将查询和数据连接在一起，或者执行带有立即执行或exec()的恶意数据。
- 使用正确的或“白名单”的具有恰当规范化的输入验证方法。
  - 该方法防御并不完善，因为不同应用程序在输入中需要的特殊字符也可能引起漏洞存在。
- 动态查询可以使用解释器的特定转义语法转义特殊字符。
  - SQL结构，比如：表名、列名等无法转义，因此用户提供的结构名是非常危险的。这是编写软件中的一个常见问题。
- 止损：在查询中使用LIMIT和其他SQL控件，减少SQL注入泄露的数据量。

检测办法：
- 代码评审是最有效的检测应用程序的注入风险的办法之一。
- 对所有所有参数、字段、头、cookie、JSON和XML数据输入进行动态应用安全（DAST）扫描。
- 组织可以将SAST和DAST工具添加到CI/CD过程中，以便于在生产部署之前对现有或新检查的代码进行注入问题的预警。


# A2: 失效的身份认证
> 通常，通过错误使用应用程序的身份认证和会话管理功能，攻击者能够破译密码、密钥或会话令牌，或者利用其它开发缺陷来暂时性或永久性冒充其他用户的身份。


可能导致漏洞的情况：
- 允许[凭证填充](https://www.owasp.org/index.php/Credential_stuffing)，这使得攻击者获得有效用户名和密码的列表。
- 允许暴力破解或其他自动攻击。
- 允许弱密码（默认、长度、复杂度）。
- 使用弱的或失效的验证凭证，忘记密码程序，例如“基于知识的答案”。
- 使用明文、加密或弱散列(MD-5,SHA-1)密码。
- 缺少或失效的多因素身份验证。
- 暴露URL中的会话ID（例如URL重写）。
- 在成功登录后不会更新会话ID。
- 不正确地使会话ID失效。当用户不活跃的时候，用户会话或认证令牌（特别是单点登录（SSO）令牌）没有正确注销或失效。

防护办法：
- 在可能的情况下，实现多因素身份验证，以防止自动、凭证填充、暴力破解和被盗凭据再利用攻击。
- 不要使用发送或部署默认的凭证，特别是管理员用户。
- 执行弱密码检查（密码长度、复杂性和历史）。
- 确认注册、凭据恢复和API路径，通过对所有输出结果使用相同的消息，用以抵御账户枚举攻击。
- 限制登录尝试次数、增加验证复杂度。记录所有失败信息并在凭据填充、暴力破解或其他攻击被检测时提醒管理员。
- 使用服务器端安全的Session管理器，在登录后生成高度复杂的新随机SessionID。SessionID不能在URL中，可以安全地存储和当登出、闲置、超时后使其失效。


# A3: 敏感信息泄露
> 许多Web应用程序和API都无法正确保护敏感数据。攻击者可以通过窃取或修改未加密的数据来实施犯罪行为。未加密的敏感数据容易受到破坏，因此，我们需要对敏感数据加密，这些数据包括：传输中的数据、存储的数据以及浏览器的交互数据。


可能导致漏洞的情况：
- 不对敏感信息进行加密。
  - 是否是明文传输（传输协议相关）？
  - 是否对存储数据进行加密、备份？
  - 是否强制加密敏感数据，例如：用户代理（如：浏览器）指令和传输协议是否被加密？
- 不安全的密钥生成和管理以及使用弱加密算法、弱协议和弱密码。
  - 是否使用旧的或脆弱的加密算法？
  - 是否使用默认加密密钥，生成或重复使用脆弱的加密密钥，或者缺少恰当的密钥管理或密钥回转？
- 用户代理（如：应用程序、邮件客户端）是否验证服务器端证书的有效性？

防护办法：
- 首先确认敏感数据范围（包含：传输过程中的数据、存储数据）。
  - 特别是隐私法律或条例中规定需要加密的数据。
- 进行数据分类，并根据分类进行访问控制。
- 根据敏感数据保护相关的法律和条例要求保护敏感数据。
- 尽快清除过期敏感数据。
- 确保存储的所有敏感数据被加密。
- 确保使用了最新的、强大的标准算法或密码、参数、协议和密钥。
- 确保使用密码专用算法或工具存储密码。
- 确保密钥管理到位。
- 确保传输过程（TLS）中的数据被加密且数据加密被强制执行（HTTP严格安全传输协议）。
- 禁止缓存对包含敏感数据的响应。
- 单独验证每个安全配置项（基线）的有效性。


# A4: XML外部实体（XXE）
> 许多较早的或配置错误的XML处理器评估了XML文件中的外部实体引用。攻击者可以利用外部实体窃取使用URI文件处理器的内部文件和共享文件、监听内部扫描端口、执行远程代码和实施拒绝服务攻击。


漏洞影响：
- XXE缺陷可用于提取数据、执行远程服务器请求、扫描内部系统、执行拒绝服务攻击和其他攻击。
- 业务影响取决于所有受影响的应用程序和数据保护需求。

可能导致漏洞的情况：
- 应用程序直接接受XML文件上传、任意数据插入XML文件，并提交给XML处理器解析。
- 在应用程序或基于Web服务的SOAP中，所有XML处理器都启用了文档类型定义（DTDs）。
- 为了实现安全性或单点登录（SSO），应用程序使用SAML进行身份认证（SAML使用XML进行身份确认）。
- 如果使用v1.2之前的SOAP，并将XML实体传递到SOAP框架，那么它可能受到XXE攻击。
- 存在XXE缺陷的应用程序更容易受到拒绝服务攻击，包括：[Billion Laughs 攻击](https://en.wikipedia.org/wiki/Billion_laughs_attack)。

防护办法：
- 开发人员培训是识别和减少XXE缺陷的关键。
- 尽可能使用简单的数据格式（如：JSON），避免对敏感数据进行序列化。
- 及时修复或更新应用程序或底层操作系统使用的所有XML处理器和库。同时，通过依赖项检测，将SOAP更新到1.2版本或更高版本。
- 参考[《OWASP Cheat Sheet 'XXE Prevention'》](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.md)，在应用程序的所有XML解析器中禁用XML外部实体和DTD进程。
- 在服务器端实施“白名单”输入验证、过滤和清理。
- 验证XML或XSL文件上传功能是否使用XSD验证或其他类似验证方法来验证上传的XML文件。
- 如果无法实现这些控制，请考虑使用虚拟修复程序、API安全网关或WAF来检测、监控和防止XXE攻击。

检测办法：
- SAST工具可以检测源代码中的XXE漏洞。


# A5: 失效的访问控制
> 未对通过身份验证的用户实施恰当的访问控制。攻击者可以利用这些缺陷访问未经授权的功能或数据，例如：访问其他用户的帐户、查看敏感文件、修改其他用户的数据、更改访问权限等。


可能导致漏洞的情况：
- 通过修改URL、内部应用程序状态或HTML页面绕过访问控制检查，或简单地使用自定义的API 攻击工具。
- 允许将主键更改为其他用户的记录，例如查看或编辑他人的帐户。
- 特权提升。在不登录的情况下假扮用户，或以用户身份登录时充当管理员。
- 元数据操作，如重放或篡改JWT 访问控制令牌，或作以提升权限的cookie 或隐藏字段。
- CORS配置错误允许未授权的API访问。
- 以未通过身份验证的用户身份强制浏览的通过身份验证时才能看到的页面、或作为标准用户访问具有相关权限的页面、或API没有对POST、PUT和DELETE强制执行访问控制。

防护办法：
- 除公有资源外，默认情况下拒绝访问。
- 使用一次性的访问控制机制，并在整个应用程序中不断重用它们，包括最小化CORS使用。
- 建立访问控制模型以强制执行所有权记录，而不是接受用户创建、读取、更新或删除的任何记录。
- 域访问控制对每个应用程序都是唯一的，但业务限制要求应由域模型强制执行。
- 禁用Web服务器目录列表，并确保文件元数据（如：git）不存在于Web的根目录中。
- 记录失败的访问控制，并在适当时向管理员告警（如：重复故障）。
- 对API和控制器的访问进行速率限制，以最大限度地降低自动化攻击工具的危害。
- 当用户注销后，服务器上的JWT令牌应失效。

检测办法：
- SAST工具和DAST工具可以检测到访问控制的缺失，但不能验证其功能是否正常，所以通常不适用于自动化的静态或动态测试。
- 手动测试是检测访问控制缺失或失效的最佳方法，包括：HTTP方法（如：GET和PUT）、控制器、直接对象引用等。
- 在某些特定框架下通过自动化检测访问控制缺失。

# A6: 安全配置错误
> 安全配置错误通常是由于不安全的默认配置、不完整的临时配置、开源云存储、错误的HTTP标头配置以及包含敏感信息的详细错误信息所造成的。因此，我们不仅需要对所有的操作系统、框架、库和应用程序进行安全配置，而且必须及时修补和升级它们。攻击者能够通过未修复的漏洞、访问默认账户、不再使用的页面、未受保护的文件和目录等来取得对系统的未授权的访问或了解。


可能导致漏洞的情况：
- 应用程序栈堆的任何部分都缺少适当的安全加固，或者云服务的权限配置错误。
- 应用程序启用或安装了不必要的功能（例如：端口、服务、网页、帐户或权限）。
- 默认帐户的密码仍然可用且没有更改。
- 错误处理机制向用户披露堆栈跟踪或其他大量错误信息。
- 系统更新后，禁用或不安全地配置最新的安全功能。
- 应用程序服务器、应用程序框架（如：Struts、Spring、ASP.NET）、库文件、数据库等没有进行安全配置。
- 服务器不发送安全标头或指令，或者未对服务器进行安全配置。
- 您的应用软件已过期或易受攻击（参见[A9: 使用含有已知漏洞的组件]）。


防护办法：
- 建立安全配置基线。
  - 开发、质量保证和生产环境都应该进行相同配置。
  - 在每个环境中使用不同的密码。
  - 配置过程自动化。
- 搭建最小化平台。
  - 不包含任何不必要的功能、组件、文档和示例。
  - 移除或不安装不适用的功能和框架。
- 检查和修复安全配置项来适应最新的安全说明、更新和补丁，并将其作为更新管理过程的一部分。
  - 在检查过程中，应特别注意云存储权限（如：S3桶权限）。
- 使用能在组件和用户间提供有效的分离和安全性的分段应用程序架构，包括：分段、容器化和云安全组。
- 向客户端发送安全指令，如：[安全标头](https://www.owasp.org/index.php/OWASP_Secure_Headers_Project)。


检测办法：
- 自动扫描器可用于检测错误的安全配置、默认帐户的使用或配置、不必要的服务、遗留选项等。



# A7: 跨站脚本（XSS）
> 当应用程序的新网页中包含不受信任的、未经恰当验证或转义的数据时，或者使用可以创建HTML或JavaScript 的浏览器API更新现有的网页时，就会出现XSS缺陷。XSS让攻击者能够在受害者的浏览器中执行脚本，并劫持用户会话、破坏网站或将用户重定向到恶意站点。


漏洞影响：
- 对于反射型和DOM型XSS影响是中等的。
- 对于存储型XSS影响更为严重，如，在受攻击者的浏览器上执行远程代码，窃取凭证和会话或传递恶意软件等。
- 典型的XSS攻击可导致盗取session、账户、绕过MFA、DIV替换、对用户浏览器的攻击（例如：恶意软件下载、键盘记录）以及其他用户侧的攻击。

可能导致漏洞的情况：
- 反射式XSS
  - 应用程序或API包括未经验证和未经转义的用户输入，作为HTML输出的一部分。
  - 一个成功的攻击可以让攻击者在受害者的浏览器中执行任意的HTML和JavaScript。
  - 用户将需要与指向攻击者控制页面的某些恶意链接进行交互，例如恶意漏洞网站，广告或类似内容。
- 存储式XSS
  - 应用或者API将未净化的用户输入存储下来了，并在后期在其他用户或者管理员的页面展示出来。
- 基于DOM的XSS
  - 会动态的将攻击者可控的内容加入页面的JavaScript框架、单页面程序或API存在这种类型的漏洞。
  - 应该避免将攻击者可控的数据发送给不安全的JavaScript API。


防护办法：
- 将不可信数据与动态的浏览器内容区分开；
- 使用设计上就会自动编码来解决XSS问题的框架，如：Ruby 3.0或ReactJS。
  - 了解每个框架的XSS保护的局限性，并适当地处理未覆盖的用例。
- 为了避免反射式或存储式的XSS漏洞，最好的办法是根据HTML输出的上下文（包括：主体、属性、JavaScript、CSS或URL）对所有不可信的HTTP请求数据进行恰当的转义。
  - 更多关于数据转义技术的信息见：[《OWASP Cheat Sheet 'XSS Prevention'》](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.md)。
- 在客户端修改浏览器Document时，为了避免DOM XSS攻击，最好的选择是实施上下文敏感数据编码。
  - 如果这种情况不能避免，可以采用[《OWASP Cheat Sheet 'DOM based XSS Prevention '》](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.md)描述的类似上下文敏感的转义技术应用于浏览器API。
- 使用[内容安全策略（CSP）](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)是对抗XSS的深度防御策略。
  - 如果不存在可以通过本地文件放置恶意代码的其他漏洞（例如：路径遍历覆盖和允许在网络中传输的易受攻击的库），则该策略有效。

检测办法：
- 自动化工具能够检测并利用所有的三种XSS形式，并且存在方便攻击者利用漏洞的框架。



# A8: 不安全的反序列化
> 不安全的反序列化会导致远程代码执行。即使反序列化缺陷不会导致远程代码执行，攻击者也可以利用它们来执行攻击，包括：重播攻击、注入攻击和特权升级攻击。

漏洞影响：
- 反序列化缺陷的影响不能被低估。它们可能导致远程代码执行攻击，这是可能发生的最严重的攻击之一。
- 业务影响取决于应用程序和数据的保护需求。


可能导致漏洞的情况：
- 对象和数据结构攻击：如果应用中存在可以在反序列化过程中或者之后被改变行为的类，攻击者可以通过改变应用逻辑或者实现远程代码执行攻击。
- 典型的数据篡改攻击，如访问控制相关的攻击，其中使用了现有的数据结构，但内容发生了变化。
- 在应用程序中，序列化可能被用于:
  - 远程和进程间通信（RPC / IPC）
  - 连线协议、Web服务、消息代理
  - 缓存/持久性
  - 数据库、缓存服务器、文件系统
  - HTTP cookie、HTML表单参数、API身份验证令牌

防护办法：
- 唯一安全的架构模式是不接受来自不受信源的序列化对象，或使用只允许原始数据类型的序列化媒体。
- 如果上述不可能的话，考虑使用下述方法：
  - 执行完整性检查，如：任何序列化对象的数字签名，以防止恶意对象创建或数据篡改。
  - 在创建对象之前强制执行严格的类型约束，因为代码通常被期望成一组可定义的类。已存在绕过办法。
  - 隔离运行那些在低特权环境中反序列化的代码。
  - 记录反序列化的例外情况和失败信息，如：传入的类型不是预期的类型，或者反序列处理引发的例外情况。
  - 限制或监视来自于容器或服务器传入和传出的反序列化网络连接。
  - 监控反序列化，当用户持续进行反序列化时，对用户进行警告。

检测办法：
- 有些工具可以被用于发现反序列化缺陷，但经常需要人工帮助来验证发现的问题。


# A9: 使用含有已知漏洞的组件
> 组件（例如：库、框架和其他软件模块）拥有和应用程序相同的权限。如果应用程序中含有已知漏洞的组件被攻击者利用，可能会造成严重的数据丢失或服务器接管。同时，使用含有已知漏洞的组件的应用程序和API可能会破坏应用程序防御、造成各种攻击并产生严重影响。



可能导致漏洞的情况：
- 不清楚使用的组件版本信息（包括：服务端和客户端），包括直接使用的或其依赖的组件；
- 软件易受攻击，不再支持或者过时。包括：OS、Web服务器、应用程序服务器、数据库管理系统（DBMS）、应用程序、API和所有的组件、运行环境和库。
- 不定期做漏洞扫描和订阅使用组件的安全公告。
- 不基于风险并及时修复或升级底层平台、框架和依赖库。很可能发生：根据变更控制，每月或每季度进行升级，这使得组织在这段时间内会受到已修复但未修补的漏洞的威胁。
- 软件工程师没有对更新的、升级的或打过补丁的组件进行兼容性测试。
- 没有对组件进行安全配置（请参考“A6:2017-安全配置错误”）。

防护办法：
应该制定一个补丁管理流程：
- 移除不使用的依赖、不需要的功能、组件、文件和文档。
- 利用如versions、DependencyCheck、retire.js等工具来持续的记录客户端和服务器端以及它们的依赖库的版本信息。持续监控如CVE和NVD等是否发布已使用组件的漏洞信息，可以使用软件分析工具来自动完成此功能。订阅关于使用组件安全漏洞的警告邮件。
- 仅从官方渠道安全的获取组件，并使用签名机制来降低组件被篡改或加入恶意漏洞的风险。
- 监控那些不再维护或者不发布安全补丁的库和组件。如果不能打补丁，可以考虑部署虚拟补丁来监控、检测或保护。



# A10: 不足的日志记录和监控
> 不足的日志记录和监控，以及事件响应缺失或无效的集成，使攻击者能够进一步攻击系统、保持持续性或转向更多系统，以及篡改、提取或销毁数据。大多数缺陷研究显示，缺陷被检测出的时间超过200天，且通常通过外部检测方检测，而不是通过内部流程或监控检测。

可能导致漏洞的情况：
- 未记录可审计性事件，如：登录、登录失败和高额交易。
- 告警和错误事件未能产生或产生不足的和不清晰的日志信息。
- 没有利用应用系统和API的日志信息来监控可疑活动。
- 日志信息仅在本地存储。
- 没有定义合理的告警阈值和制定响应处理流程。
- 渗透测试和使用DAST工具（如：OWASP ZAP）扫描没有触发告警
- 对于实时或准实时的攻击，应用程序无法检测、处理和告警。

防护办法：
- 确保所有登录、访问控制失败、输入验证失败能够被记录到日志中去，并保留足够的用户上下文信息，以识别可疑或恶意帐户，并为后期取证预留足够时间。
- 确保日志以一种能被集中日志管理解决方案使用的形式生成。
- 确保高额交易有完整性控制的审计信息，以防止篡改或删除，例如审计信息保存在只能进行记录增加的数据库表中。
- 建立有效的监控和告警机制，使可疑活动在可接受的时间内被发现和应对。
- 建立或采取一个应急响应机制和恢复计划，例如：NIST 800-61 rev 2或更新版本。
- 目前已有商业的和开源的应用程序防护框架（例如：OWASP AppSensor）、Web应用防火墙（例如：Modsecuritywith the OWASP Core Rule Set）、带有自定义仪表盘和告警功能的日志关联软件。



# 附录：OWASP Top 10 v2013
* A1: 注入
* A2: 失效的身份认证和会话管理
* A3: 跨站脚本（XSS）
* A4: 不安全的直接对象引用
* A5: 安全配置错误
* A6: 敏感信息泄露
* A7: 功能级访问控制缺失
* A8: 跨站请求伪造（CSRF）
* A9: 使用含有已知漏洞的组建
* A10: 未验证的重定向和转发

v2013 → v2017：
- 合并(2013)A4-不安全的直接对象引用与(2013)A7-功能级访问控制缺失：(2017)A5-失效的访问控制
- 删除 (2013)A8-跨站请求伪造（CSRF）
- 删除 (2013)A10-未验证的重定向和转发
- 新增 (2017)A8-不安全的反序列化
- 新增 (2017)A10-不足的日志记录和监控